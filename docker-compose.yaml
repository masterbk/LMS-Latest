version: '3'
###network
networks:
  lms-network:
    driver: bridge

###volume
volumes:
  lms-source-vol:
    driver: local
    driver_opts:
      device: ./disk/moodle-node/source/moodledata
      type: none
      o: bind
  lms-db-node1:
    driver: local
    driver_opts:
      device: ./disk/maria-db/data/node1
      type: none
      o: bind
###services
services:
  #slave node 1 / master
  lms-db-01:
    container_name: lms-db-01-cn
    hostname: lms-db-01-hn
    image: bitnami/mariadb:latest
    ports:
      - '3391:3306'
    networks:
      - lms-network
    volumes:
      - ./disk/maria-db/config/node1/my_custom.cnf:/opt/bitnami/mariadb/conf/my_custom.cnf:ro
      - lms-db-node1:/bitnami/mariadb
      - ./disk/maria-db/data/dump:/docker-entrypoint-initdb.d
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - MARIADB_EXTRA_FLAGS=--max-connect-errors=1000 --max_connections=155
      - MARIADB_ROOT_PASSWORD=root_password
    healthcheck:
      test: ['CMD', '/opt/bitnami/scripts/mariadb-galera/healthcheck.sh']
      interval: 15s
      timeout: 5s
      retries: 6
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    restart: unless-stopped
    ports:
      - 8081:80
    environment:
      - UPLOAD_LIMIT=1G
      - MEMORY_LIMIT=2G
      - PMA_HOST=lms-db-01-cn:3306
    container_name: myphpadmin
    depends_on:
      - lms-db-01
    networks:
      - lms-network
  
  ##container lms node
  #lms node 1 : nginx + php + lms moodle code
  lms-node-01:
    container_name: lms-node-01-cn
    hostname: lms-node-01-hn
    image: ngonguyentuanhhon/moodle-core-vtc:latest #moodle-vtc:v1
    restart: unless-stopped
    #build: 
    #  dockerfile: Dockerfile
    #  context: ./disk/moodle-node
    networks:
      - lms-network
    volumes:
      - ./disk/moodle-node/config/node1/php/php-fpm.conf:/usr/local/etc/php-fpm.conf
      - ./disk/moodle-node/config/node1/php/php.ini:/usr/local/etc/php/php.ini
      - ./disk/moodle-node/config/node1/php/www.conf:/usr/local/etc/php-fpm.d/www.conf
      - ./disk/moodle-node/config/node1/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./disk/moodle-node/config/node1/nginx/site-enable/vtc.conf:/etc/nginx/sites-enabled/vtc.conf
      - ./disk/moodle-node/config/config.php:/var/www/html/edu-vtc-lms/config.php
      #- lms-source-vol:/var/www/html/
      - lms-source-vol:/var/www/html/moodledata
      #- lms-nfs-service-vol:/lms/data
    ports:
      - 80:80
      - 443:443

